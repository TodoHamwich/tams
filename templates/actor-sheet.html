<section class="tams-actor-form flexcol">
    <header class="sheet-header">
        <div class="profile-img-container" data-action="editImage" data-edit="img">
            <img class="profile-img" src="{{document.img}}" title="{{document.name}}" height="100" width="100"/>
            <input type="hidden" name="img" value="{{document.img}}"/>
            <div class="image-edit-overlay">
                <i class="fas fa-edit"></i>
                <span>Change Image</span>
            </div>
        </div>
        <div class="header-details">
            <h1 class="charname">
                {{#if system.settings.isNPC}}
                <span class="npc-tag" style="background: #444; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.5em; vertical-align: middle; margin-right: 5px;">
                    {{#if (eq system.settings.npcType "squad")}}SQUAD{{else if (eq system.settings.npcType "horde")}}HORDE{{else}}NPC{{/if}}
                </span>
                {{/if}}
                <input name="name" type="text" value="{{document.name}}" placeholder="Name"/>
            </h1>
            <div class="header-row">
                <div class="physical-notes">
                    <label>Physical Notes</label>
                    <input type="text" name="system.physicalNotes" value="{{system.physicalNotes}}" placeholder="Physical characteristics..."/>
                </div>
            </div>
            <div class="header-row">
                <div class="theme-selector">
                    <label>Theme</label>
                    <select name="system.theme">
                        {{selectOptions themeOptions selected=system.theme localize=true}}
                    </select>
                </div>
            </div>
        </div>
    </header>

    <nav class="sheet-tabs tabs" data-group="primary">
        <a class="item {{#if (eq activeTab 'stats')}}active{{/if}}" data-action="setTab" data-tab="stats" title="Stats & Limbs"><i class="fas fa-user"></i></a>
        <a class="item {{#if (eq activeTab 'items')}}active{{/if}}" data-action="setTab" data-tab="items" title="Weapons & Skills"><i class="fas fa-shield-alt"></i></a>
        <a class="item {{#if (eq activeTab 'abilities')}}active{{/if}}" data-action="setTab" data-tab="abilities" title="Abilities & Resources"><i class="fas fa-bolt"></i></a>
        <a class="item {{#if (eq activeTab 'inventory')}}active{{/if}}" data-action="setTab" data-tab="inventory" title="Inventory"><i class="fas fa-boxes"></i></a>
        <a class="item {{#if (eq activeTab 'description')}}active{{/if}}" data-action="setTab" data-tab="description" title="Traits & Bio"><i class="fas fa-scroll"></i></a>
        <a class="item {{#if (eq activeTab 'modifiers')}}active{{/if}}" data-action="setTab" data-tab="modifiers" title="Modifiers"><i class="fas fa-sliders-h"></i></a>
        <a class="item {{#if (eq activeTab 'settings')}}active{{/if}}" data-action="setTab" data-tab="settings" title="Settings"><i class="fas fa-cog"></i></a>
    </nav>

    <section class="sheet-body">
        {{!-- Stats Tab --}}
        <div class="tab stats {{#if (eq activeTab 'stats')}}active{{/if}}" data-group="primary" data-tab="stats">
            <div class="upgrade-pool flexrow">
                <label>Stat Upgrade Points:</label>
                <input type="number" name="system.upgradePoints.stats" value="{{system.upgradePoints.stats}}"/>
            </div>
            <div class="grid grid-2col">
                <section class="stats-list">
                    {{#each system.stats as |stat id|}}
                    <div class="stat flexrow">
                        <label class="resource-label rollable" data-action="roll" data-roll="stat" data-stat-id="{{id}}" data-label="{{localize stat.label}}" data-stat-value="{{stat.value}}" data-stat-mod="{{stat.mod}}">
                            <i class="fas fa-dice-d20"></i> {{localize stat.label}}
                        </label>
                        <div class="stat-inputs flexrow">
                            <input type="number" name="system.stats.{{id}}.value" value="{{stat.value}}" data-dtype="Number" title="Base Value"/>
                            <span class="mod-sep">+</span>
                            <input type="number" name="system.stats.{{id}}.mod" value="{{stat.mod}}" data-dtype="Number" title="Modifier" class="small-input"/>
                        </div>
                    </div>
                    {{/each}}
                    <hr>
                    <h3 class="small-header">Special Skills</h3>
                    {{#each system.specialSkills as |skill id|}}
                    <div class="stat flexrow special-skill">
                        <label class="resource-label rollable" data-action="roll" data-stat-id="{{id}}" data-label="{{capitalize id}}" data-stat-value="{{skill.value}}">
                            <i class="fas fa-dice-d20"></i> {{capitalize id}}
                        </label>
                        <input type="number" name="system.specialSkills.{{id}}.value" value="{{skill.value}}" data-dtype="Number"/>
                    </div>
                    {{/each}}
                </section>

                <section class="limbs-list">
                    {{!-- Total HP Resource --}}
                    <div class="resource-item hp flexcol" style="border-bottom: 2px solid #7a7971; margin-bottom: 10px; padding-bottom: 5px;">
                        <div class="flexrow">
                            <label class="resource-label">Total HP {{#if (or (eq system.settings.npcType 'squad') (eq system.settings.npcType 'horde'))}}(Size: {{system.settings.squadSize}}){{/if}}</label>
                            <div class="bar-container">
                                <input type="number" name="system.hp.value" value="{{system.hp.value}}" max="{{system.hp.max}}" disabled/>
                                <div class="bar">
                                    <div class="fill" style="width: {{hpPercentage}}%; background: #e74c3c;"></div>
                                </div>
                                <span class="max-label"> / {{system.hp.max}} </span>
                            </div>
                        </div>
                    </div>

                    <h3 class="small-header">Limbs (HP / Armor) <a class="full-heal" data-action="fullHeal" title="Full Heal All Limbs"><i class="fas fa-heartbeat"></i></a></h3>
                    {{#each system.limbs as |limb id|}}
                    <div class="limb-row flexrow {{#if limb.injured}}injured-limb{{/if}} {{#if limb.criticallyInjured}}crit-injured{{/if}}">
                        <label class="resource-label limb-label" title="{{#if limb.criticallyInjured}}CRITICALLY INJURED{{/if}}{{#if (and limb.injured (not limb.criticallyInjured))}}INJURED{{/if}}">
                            {{#if limb.criticallyInjured}}<i class="fas fa-skull crit-icon"></i>{{else if limb.injured}}<i class="fas fa-exclamation-triangle injured-icon"></i>{{/if}}
                            {{limb.label}}
                        </label>
                        <div class="limb-hp flexrow">
                            <input type="number" name="system.limbs.{{id}}.value" value="{{limb.value}}" class="small-input {{#if (lt limb.value 0)}}negative-hp{{/if}}" title="Current HP"/>
                            <span>/{{limb.max}}</span>
                        </div>
                        <div class="limb-armor flexrow">
                            <input type="checkbox" name="system.limbs.{{id}}.injured" {{checked limb.injured}} title="Injured?"/>
                            <input type="checkbox" name="system.limbs.{{id}}.criticallyInjured" {{checked limb.criticallyInjured}} title="Critically Injured?"/>
                            <label>Armour</label>
                            <select name="system.limbs.{{id}}.equippedArmorId" style="max-width: 80px;" title="Equipped Armor Item">
                                {{selectOptions (lookup ../limbArmorOptions id) selected=limb.equippedArmorId}}
                            </select>
                            <input type="number" name="system.limbs.{{id}}.armor" value="{{limb.armor}}" class="small-input" max="40" min="0" {{#if limb.hasEquippedArmor}}disabled{{/if}}/>
                            <span>/</span>
                            <input type="number" name="system.limbs.{{id}}.armorMax" value="{{limb.armorMax}}" class="small-input" max="40" min="0" {{#if limb.hasEquippedArmor}}disabled{{/if}}/>
                        </div>
                    </div>
                    {{/each}}
                </section>
            </div>
        </div>

        {{!-- Items Tab --}}
        <div class="tab items {{#if (eq activeTab 'items')}}active{{/if}}" data-group="primary" data-tab="items">
            <div class="upgrade-pool flexrow">
                <label>Weapon Upgrade Points:</label>
                <input type="number" name="system.upgradePoints.weapons" value="{{system.upgradePoints.weapons}}"/>
                <label>Skill Upgrade Points:</label>
                <input type="number" name="system.upgradePoints.skills" value="{{system.upgradePoints.skills}}"/>
            </div>
            <h3>Weapons <a data-action="itemCreate" data-type="weapon"><i class="fas fa-plus"></i> Add</a></h3>
            <li class="item flexrow item-header">
                <div class="item-name">Name</div>
                <div class="item-stat">Dmg</div>
                <div class="item-stat">Fam</div>
                <div class="item-stat">Rate</div>
                <div class="item-stat">Ammo</div>
                <div class="item-stat">Total</div>
                <div class="item-stat">Equip</div>
                <div class="item-controls"></div>
            </li>
            <ol class="items-list">
                {{#each weapons as |item id|}}
                <li class="item flexrow" data-item-id="{{item.id}}">
                    <img src="{{item.img}}" title="{{item.name}}" width="24" height="24"/>
                    <h4 class="item-name rollable" data-action="roll" data-item-id="{{item.id}}" data-label="{{item.name}}" data-familiarity="{{item.system.familiarity}}">
                        {{item.name}}
                    </h4>
                    <div class="item-stat">{{item.system.calculatedDamage}}</div>
                    <div class="item-stat">
                        <input type="number" class="small-input" data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.familiarity" value="{{item.system.familiarity}}"/>
                    </div>
                    <div class="item-stat">
                        {{#if item.system.isRanged}}
                        <select class="fire-rate-select" data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.fireRate">
                            <option value="1" {{#if (eq item.system.fireRate "1")}}selected{{/if}}>S</option>
                            <option value="3" {{#if (eq item.system.fireRate "3")}}selected{{/if}}>3</option>
                            <option value="auto" {{#if (eq item.system.fireRate "auto")}}selected{{/if}}>A</option>
                            <option value="custom" {{#if (eq item.system.fireRate "custom")}}selected{{/if}}>C</option>
                        </select>
                        {{else}}
                        -
                        {{/if}}
                    </div>
                    <div class="item-stat">
                        {{#if item.system.isRanged}}
                        <input type="number" class="small-input" data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.ammo.current" value="{{item.system.ammo.current}}"/>
                        {{else}}
                        -
                        {{/if}}
                    </div>
                    <div class="item-stat">
                        {{#if item.system.isRanged}}
                        <input type="number" class="small-input" data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.ammo.total" value="{{item.system.ammo.total}}"/>
                        {{else}}
                        -
                        {{/if}}
                    </div>
                    <div class="item-stat">
                        <input type="checkbox" data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.equipped" {{checked item.system.equipped}}/>
                    </div>
                    <div class="item-controls">
                        <a class="item-control" data-action="itemEdit" title="Edit Item"><i class="fas fa-edit"></i></a>
                        <a class="item-control" data-action="itemDelete" title="Delete Item"><i class="fas fa-trash"></i></a>
                    </div>
                </li>
                {{/each}}
            </ol>

            <h3>Skills <a data-action="itemCreate" data-type="skill"><i class="fas fa-plus"></i> Add</a></h3>
            <li class="item flexrow item-header">
                <div class="item-name">Name</div>
                <div class="item-stat">Fam</div>
                <div class="item-stat">Stat</div>
                <div class="item-controls"></div>
            </li>
            <ol class="items-list">
                {{#each skills as |item id|}}
                <li class="item flexrow" data-item-id="{{item.id}}">
                    <h4 class="item-name rollable" data-action="roll" data-item-id="{{item.id}}" data-label="{{item.name}}" data-familiarity="{{item.system.familiarity}}">
                        {{item.name}}
                    </h4>
                    <div class="item-stat">
                        <input type="number" class="small-input" data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.familiarity" value="{{item.system.familiarity}}"/>
                    </div>
                    <div class="item-stat">
                        <select class="fire-rate-select" data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.stat">
                            {{selectOptions ../statOptions selected=item.system.stat localize=true}}
                        </select>
                    </div>
                    <div class="item-controls">
                        <a class="item-control" data-action="itemEdit" title="Edit Item"><i class="fas fa-edit"></i></a>
                        <a class="item-control" data-action="itemDelete" title="Delete Item"><i class="fas fa-trash"></i></a>
                    </div>
                </li>
                {{/each}}
            </ol>
        </div>

        {{!-- Abilities & Resources Tab --}}
        <div class="tab abilities {{#if (eq activeTab 'abilities')}}active{{/if}}" data-group="primary" data-tab="abilities">
            <div class="flexrow">
                <h3>Resources</h3>
                <a data-action="resourceAdd"><i class="fas fa-plus"></i> Add Resource</a>
            </div>
            <ol class="resources-list">
                {{!-- Main Stamina Resource --}}
                <li class="resource-item stamina flexcol">
                    <div class="flexrow">
                        <label class="resource-label">Stamina</label>
                        <div class="bar-container">
                            <input type="number" name="system.stamina.value" value="{{system.stamina.value}}" max="{{system.stamina.max}}" min="0"/>
                            <div class="bar">
                                <div class="fill" style="width: {{staminaPercentage}}%; background: {{system.stamina.color}};"></div>
                            </div>
                            <span class="max-label"> / {{system.stamina.max}} </span>
                        </div>
                    </div>
                </li>

                {{!-- Custom Resources --}}
                {{#each customResourceData as |res index|}}
                <li class="resource-item flexcol" data-index="{{index}}">
                    <div class="flexrow">
                        <input type="text" name="system.customResources.{{index}}.name" value="{{res.name}}" placeholder="Resource Name" class="resource-name-input"/>
                        <div class="bar-container">
                            <input type="number" name="system.customResources.{{index}}.value" value="{{res.value}}" max="{{res.max}}" min="0"/>
                            <div class="bar">
                                <div class="fill" style="width: {{res.percentage}}%; background: {{res.color}};"></div>
                            </div>
                            <span class="max-label"> / {{res.max}} </span>
                            <a data-action="resourceDelete" data-index="{{index}}" class="delete-resource"><i class="fas fa-trash"></i></a>
                        </div>
                    </div>
                </li>
                {{/each}}
            </ol>

            <hr>

            <div class="upgrade-pool flexrow">
                <label>Ability Upgrade Points:</label>
                <input type="number" name="system.upgradePoints.abilities" value="{{system.upgradePoints.abilities}}"/>
            </div>
            <h3>Abilities <a data-action="itemCreate" data-type="ability"><i class="fas fa-plus"></i> Add</a></h3>
            <ol class="items-list">
                {{#each abilities as |item id|}}
                <li class="item flexrow" data-item-id="{{item.id}}">
                    <h4 class="item-name rollable" data-action="roll" data-item-id="{{item.id}}" data-label="{{item.name}}" data-familiarity="{{item.system.familiarity}}">
                        {{item.name}} 
                        {{#if item.system.isAttack}}
                        (Dmg: {{item.system.calculatedDamage}})
                        {{/if}}
                        {{#if (gt item.system.uses.max 0)}}
                        (Uses: {{item.system.uses.value}}/{{item.system.uses.max}})
                        {{else}}
                            {{#if item.system.isApex}}
                            (Apex: {{item.system.uses.value}}/{{item.system.uses.max}})
                            {{else}}
                            (Cost: {{item.system.cost}})
                            {{/if}}
                        {{/if}}
                    </h4>
                    <div class="item-controls">
                        <a class="item-control" data-action="itemEdit" title="Edit Item"><i class="fas fa-edit"></i></a>
                        <a class="item-control" data-action="itemDelete" title="Delete Item"><i class="fas fa-trash"></i></a>
                    </div>
                </li>
                {{/each}}
            </ol>
        </div>

        {{!-- Inventory Tab --}}
        <div class="tab inventory {{#if (eq activeTab 'inventory')}}active{{/if}}" data-group="primary" data-tab="inventory">
            <div class="carry-weight flexcol">
                <div class="flexrow">
                    <span>Carry Capacity: <b>{{inventory.usedMedium}}</b> / <b>{{inventory.maxMedium}}</b> Medium Items</span>
                    {{#if inventory.isEncumbered}} <span class="encumbered">(Encumbered - Speed Halved)</span>{{/if}}
                </div>
                <div class="bar-container" style="height: 8px; margin-top: 2px;">
                    <div class="bar">
                        <div class="fill" style="width: {{capacityPercentage}}%; background: {{#if inventory.isEncumbered}}#e74c3c{{else}}#3498db{{/if}};"></div>
                    </div>
                </div>
            </div>

            <div class="backpack-slot-container" style="border-bottom: 2px solid #7a7971; margin-bottom: 5px; padding-bottom: 5px; flex: 0 0 auto;">
                <h4 class="inventory-section-header" style="margin-top: 0; background: #5c3b1e;">
                    <span>Containers / Backpacks</span>
                    <div class="inventory-controls">
                        <a data-action="itemCreate" data-type="backpack" title="Add Backpack"><i class="fas fa-plus"></i> Add</a>
                    </div>
                </h4>
                {{#if inventoryBackpacks.length}}
                <ol class="items-list">
                    {{#each inventoryBackpacks as |item id|}}
                    <li class="item flexrow {{#if item.system.equipped}}equipped-backpack{{/if}}" data-item-id="{{item.id}}" style="border-bottom: 1px solid #ccc; padding: 4px;">
                        <img src="{{item.img}}" title="{{item.name}}" width="32" height="32" style="border: 1px solid #7a7971; border-radius: 3px;"/>
                        <div class="item-name-details flexcol" style="flex: 1; padding-left: 10px;">
                            <h4 class="item-name" style="margin: 0; font-family: 'MedievalSharp', serif; font-size: 1.1em;">{{item.name}}</h4>
                            <div class="item-properties" style="font-size: 0.8em; color: #666;">
                                <span>Cap: {{item.system.capacity}} Med</span> | <span>Mod: {{item.system.modifier}}x</span>
                                {{#if item.system.penalties.active}} | <span style="color: #c62828;"><i class="fas fa-exclamation-circle"></i> Penalties Active</span>{{/if}}
                            </div>
                        </div>
                        <div class="item-stat" style="flex: 0 0 100px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px;">
                            <label style="font-size: 10px; text-transform: uppercase;">Equip</label>
                            <input type="checkbox" data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.equipped" {{checked item.system.equipped}}/>
                        </div>
                        <div class="item-controls" style="flex: 0 0 60px; display: flex; align-items: center; justify-content: flex-end; gap: 5px;">
                            <a class="item-control" data-action="itemEdit" title="Edit Item"><i class="fas fa-edit"></i></a>
                            <a class="item-control" data-action="itemDelete" title="Delete Item"><i class="fas fa-trash"></i></a>
                        </div>
                    </li>
                    {{/each}}
                </ol>
                {{else}}
                <div class="no-backpacks" style="font-size: 0.85em; font-style: italic; color: #888; text-align: center; padding: 8px;">
                    No backpack equipped. Items in "Backpack" location will be inaccessible.
                </div>
                {{/if}}
            </div>

            <div class="inventory-scroll">
                <li class="item flexrow item-header">
                    <div class="item-name">Name</div>
                    <div class="item-stat" style="flex: 0 0 50px; text-align: center;">Qty</div>
                    <div class="item-stat" style="flex: 0 0 70px; text-align: center;">Size</div>
                    <div class="item-stat" style="flex: 0 0 90px; text-align: center;">Location</div>
                    <div class="item-controls" style="flex: 0 0 50px;"></div>
                </li>

                <h4 class="inventory-section-header">
                    <span>Weapons</span>
                    <div class="inventory-controls">
                        <a data-action="itemCreate" data-type="weapon" title="Add Weapon"><i class="fas fa-plus"></i> Add</a>
                    </div>
                </h4>
                {{#if weapons.length}}
                <ol class="items-list">
                    {{#each weapons as |item id|}}
                    <li class="item flexrow {{#if item.isGreyedOut}}greyed-out{{/if}}" data-item-id="{{item.id}}">
                        <img src="{{item.img}}" title="{{item.name}}" width="24" height="24" style="margin-right: 5px;"/>
                        <h4 class="item-name">{{item.name}} {{#if item.system.equipped}}(Equipped){{/if}}</h4>
                        <div class="item-stat" style="flex: 0 0 50px; text-align: center;">
                            <input type="number" class="small-input" data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.quantity" value="{{item.system.quantity}}"/>
                        </div>
                        <div class="item-stat" style="flex: 0 0 70px; text-align: center;">
                            <select data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.size" style="height: 20px; font-size: 0.8em;">
                                {{selectOptions ../sizeOptions selected=item.system.size}}
                            </select>
                        </div>
                        <div class="item-stat" style="flex: 0 0 90px; text-align: center;">
                            <select data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.location" style="height: 20px; font-size: 0.8em;">
                                {{selectOptions ../locationOptions selected=item.system.location}}
                            </select>
                        </div>
                        <div class="item-controls" style="flex: 0 0 50px;">
                            <a class="item-control" data-action="itemEdit" title="Edit Item"><i class="fas fa-edit"></i></a>
                            <a class="item-control" data-action="itemDelete" title="Delete Item"><i class="fas fa-trash"></i></a>
                        </div>
                    </li>
                    {{/each}}
                </ol>
                {{/if}}

                <h4 class="inventory-section-header">
                    <span>Armor</span>
                    <div class="inventory-controls">
                        <a data-action="itemCreate" data-type="armor" title="Add Armor"><i class="fas fa-plus"></i> Add</a>
                    </div>
                </h4>
                {{#if inventoryArmor.length}}
                <ol class="items-list">
                    {{#each inventoryArmor as |item id|}}
                    <li class="item flexrow {{#if item.isGreyedOut}}greyed-out{{/if}}" data-item-id="{{item.id}}">
                        <img src="{{item.img}}" title="{{item.name}}" width="24" height="24"/>
                        <h4 class="item-name">{{item.name}}</h4>
                        <div class="item-stat" style="flex: 0 0 50px; text-align: center;">{{item.system.quantity}}</div>
                        <div class="item-stat" style="flex: 0 0 70px; text-align: center;">
                            <select data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.size" style="height: 20px; font-size: 0.8em;">
                                {{selectOptions ../sizeOptions selected=item.system.size}}
                            </select>
                        </div>
                        <div class="item-stat" style="flex: 0 0 90px; text-align: center;">
                            <select data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.location" style="height: 20px; font-size: 0.8em;">
                                {{selectOptions ../locationOptions selected=item.system.location}}
                            </select>
                        </div>
                        <div class="item-controls" style="flex: 0 0 50px;">
                            <a class="item-control" data-action="itemEdit" title="Edit Item"><i class="fas fa-edit"></i></a>
                            <a class="item-control" data-action="itemDelete" title="Delete Item"><i class="fas fa-trash"></i></a>
                        </div>
                    </li>
                    {{/each}}
                </ol>
                {{/if}}

                <h4 class="inventory-section-header">
                    <span>Consumables</span>
                    <div class="inventory-controls">
                        <a data-action="itemCreate" data-type="consumable" title="Add Consumable"><i class="fas fa-plus"></i> Add</a>
                    </div>
                </h4>
                {{#if inventoryConsumables.length}}
                <ol class="items-list">
                    {{#each inventoryConsumables as |item id|}}
                    <li class="item flexrow {{#if item.isGreyedOut}}greyed-out{{/if}}" data-item-id="{{item.id}}">
                        <img src="{{item.img}}" title="{{item.name}}" width="24" height="24"/>
                        <h4 class="item-name">{{item.name}} ({{item.system.uses.value}}/{{item.system.uses.max}})</h4>
                        <div class="item-stat" style="flex: 0 0 50px; text-align: center;">
                            <input type="number" class="small-input" data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.quantity" value="{{item.system.quantity}}"/>
                        </div>
                        <div class="item-stat" style="flex: 0 0 70px; text-align: center;">
                            <select data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.size" style="height: 20px; font-size: 0.8em;">
                                {{selectOptions ../sizeOptions selected=item.system.size}}
                            </select>
                        </div>
                        <div class="item-stat" style="flex: 0 0 90px; text-align: center;">
                            <select data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.location" style="height: 20px; font-size: 0.8em;">
                                {{selectOptions ../locationOptions selected=item.system.location}}
                            </select>
                        </div>
                        <div class="item-controls" style="flex: 0 0 50px;">
                            <a class="item-control" data-action="itemEdit" title="Edit Item"><i class="fas fa-edit"></i></a>
                            <a class="item-control" data-action="itemDelete" title="Delete Item"><i class="fas fa-trash"></i></a>
                        </div>
                    </li>
                    {{/each}}
                </ol>
                {{/if}}

                <h4 class="inventory-section-header">
                    <span>Tools</span>
                    <div class="inventory-controls">
                        <a data-action="itemCreate" data-type="tool" title="Add Tool"><i class="fas fa-plus"></i> Add</a>
                    </div>
                </h4>
                {{#if inventoryTools.length}}
                <ol class="items-list">
                    {{#each inventoryTools as |item id|}}
                    <li class="item flexrow {{#if item.isGreyedOut}}greyed-out{{/if}}" data-item-id="{{item.id}}">
                        <img src="{{item.img}}" title="{{item.name}}" width="24" height="24"/>
                        <h4 class="item-name">{{item.name}}</h4>
                        <div class="item-stat" style="flex: 0 0 50px; text-align: center;">
                            <input type="number" class="small-input" data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.quantity" value="{{item.system.quantity}}"/>
                        </div>
                        <div class="item-stat" style="flex: 0 0 70px; text-align: center;">
                            <select data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.size" style="height: 20px; font-size: 0.8em;">
                                {{selectOptions ../sizeOptions selected=item.system.size}}
                            </select>
                        </div>
                        <div class="item-stat" style="flex: 0 0 90px; text-align: center;">
                            <select data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.location" style="height: 20px; font-size: 0.8em;">
                                {{selectOptions ../locationOptions selected=item.system.location}}
                            </select>
                        </div>
                        <div class="item-controls" style="flex: 0 0 50px;">
                            <a class="item-control" data-action="itemEdit" title="Edit Item"><i class="fas fa-edit"></i></a>
                            <a class="item-control" data-action="itemDelete" title="Delete Item"><i class="fas fa-trash"></i></a>
                        </div>
                    </li>
                    {{/each}}
                </ol>
                {{/if}}

                <h4 class="inventory-section-header">
                    <span>Quest Items</span>
                    <div class="inventory-controls">
                        <a data-action="itemCreate" data-type="questItem" title="Add Quest Item"><i class="fas fa-plus"></i> Add</a>
                    </div>
                </h4>
                {{#if inventoryQuestItems.length}}
                <ol class="items-list">
                    {{#each inventoryQuestItems as |item id|}}
                    <li class="item flexrow {{#if item.isGreyedOut}}greyed-out{{/if}}" data-item-id="{{item.id}}">
                        <img src="{{item.img}}" title="{{item.name}}" width="24" height="24"/>
                        <h4 class="item-name">{{item.name}}</h4>
                        <div class="item-stat" style="flex: 0 0 50px; text-align: center;">
                            <input type="number" class="small-input" data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.quantity" value="{{item.system.quantity}}"/>
                        </div>
                        <div class="item-stat" style="flex: 0 0 70px; text-align: center;">
                            <select data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.size" style="height: 20px; font-size: 0.8em;">
                                {{selectOptions ../sizeOptions selected=item.system.size}}
                            </select>
                        </div>
                        <div class="item-stat" style="flex: 0 0 90px; text-align: center;">
                            <select data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.location" style="height: 20px; font-size: 0.8em;">
                                {{selectOptions ../locationOptions selected=item.system.location}}
                            </select>
                        </div>
                        <div class="item-controls" style="flex: 0 0 50px;">
                            <a class="item-control" data-action="itemEdit" title="Edit Item"><i class="fas fa-edit"></i></a>
                            <a class="item-control" data-action="itemDelete" title="Delete Item"><i class="fas fa-trash"></i></a>
                        </div>
                    </li>
                    {{/each}}
                </ol>
                {{/if}}

                <h4 class="inventory-section-header">
                    <span>Misc Equipment</span>
                    <div class="inventory-controls">
                        <a data-action="itemCreate" data-type="equipment" title="Add Misc"><i class="fas fa-plus"></i> Add</a>
                    </div>
                </h4>
                {{#if inventoryMisc.length}}
                <ol class="items-list">
                    {{#each inventoryMisc as |item id|}}
                    <li class="item flexrow {{#if item.isGreyedOut}}greyed-out{{/if}}" data-item-id="{{item.id}}">
                        <img src="{{item.img}}" title="{{item.name}}" width="24" height="24"/>
                        <h4 class="item-name">{{item.name}}</h4>
                        <div class="item-stat" style="flex: 0 0 50px; text-align: center;">
                            <input type="number" class="small-input" data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.quantity" value="{{item.system.quantity}}"/>
                        </div>
                        <div class="item-stat" style="flex: 0 0 70px; text-align: center;">
                            <select data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.size" style="height: 20px; font-size: 0.8em;">
                                {{selectOptions ../sizeOptions selected=item.system.size}}
                            </select>
                        </div>
                        <div class="item-stat" style="flex: 0 0 90px; text-align: center;">
                            <select data-action="updateItemField" data-item-id="{{item.id}}" data-field="system.location" style="height: 20px; font-size: 0.8em;">
                                {{selectOptions ../locationOptions selected=item.system.location}}
                            </select>
                        </div>
                        <div class="item-controls" style="flex: 0 0 50px;">
                            <a class="item-control" data-action="itemEdit" title="Edit Item"><i class="fas fa-edit"></i></a>
                            <a class="item-control" data-action="itemDelete" title="Delete Item"><i class="fas fa-trash"></i></a>
                        </div>
                    </li>
                    {{/each}}
                </ol>
                {{/if}}
            </div>

            <div class="currency-footer">
                <h4 class="inventory-section-header">Currencies</h4>
                <div class="flexrow currency-list" style="flex-wrap: wrap; gap: 5px; margin-bottom: 8px;">
                    {{#each currencies as |cur|}}
                    {{#if cur.enabled}}
                    <div class="currency-item flexrow" style="align-items: center; background: rgba(0,0,0,0.05); padding: 2px 5px; border-radius: 3px; flex: 0 0 120px;">
                        <label style="font-size: 0.9em; flex: 1;">{{cur.name}}</label>
                        <input type="number" name="system.currencies.{{cur.name}}" value="{{cur.value}}" style="width: 50px; height: 20px; text-align: right;"/>
                    </div>
                    {{/if}}
                    {{/each}}
                </div>
            </div>
        </div>


        {{!-- Description Tab --}}
        <div class="tab {{#if (eq activeTab 'description')}}active{{/if}}" data-group="primary" data-tab="description">
            <h3>Traits</h3>
            <textarea name="system.traits" rows="5">{{system.traits}}</textarea>
            <hr>
            <h3>Biography</h3>
            <textarea name="system.description" rows="10">{{system.description}}</textarea>
        </div>

        {{!-- Modifiers Tab --}}
        <div class="tab modifiers {{#if (eq activeTab 'modifiers')}}active{{/if}}" data-group="primary" data-tab="modifiers">
            <div class="flexcol">
                <div class="grid grid-2col">
                    <div class="modifier-group">
                        <h3>Stamina</h3>
                        <div class="flexrow">
                            <label>Multiplier</label>
                            <input type="number" name="system.stamina.mult" value="{{system.stamina.mult}}" step="0.25" style="width: 50px;"/>
                            <label>Color</label>
                            <input type="color" name="system.stamina.color" value="{{system.stamina.color}}" style="width: 30px; padding: 0;"/>
                        </div>
                    </div>
                    <div class="modifier-group">
                        <h3>Combat</h3>
                        <div class="flexrow">
                            <label>Behind Mult</label>
                            <input type="number" name="system.behindMult" value="{{system.behindMult}}" step="0.05" style="width: 50px;"/>
                        </div>
                    </div>
                </div>
                <hr>
                <h3>Limb Multipliers</h3>
                <div class="grid grid-2col">
                    {{#each system.limbs as |limb id|}}
                    <div class="flexrow">
                        <label style="font-size: 13px;">{{limb.label}}</label>
                        <input type="number" name="system.limbs.{{id}}.mult" value="{{limb.mult}}" step="0.25" style="width:45px;"/>
                    </div>
                    {{/each}}
                </div>
                <hr>
                <h3>Resource Modifiers</h3>
                {{#each system.customResources as |res index|}}
                <div class="flexrow modifier-row" data-index="{{index}}">
                    <label style="flex:1">{{res.name}}</label>
                    <select name="system.customResources.{{index}}.stat" style="width:100px;">
                        {{selectOptions ../statOptions selected=res.stat localize=true}}
                    </select>
                    <small>x</small>
                    <input type="number" name="system.customResources.{{index}}.mult" value="{{res.mult}}" step="0.25" style="width: 45px;"/>
                    <small>+</small>
                    <input type="number" name="system.customResources.{{index}}.bonus" value="{{res.bonus}}" style="width: 40px;"/>
                    <input type="color" name="system.customResources.{{index}}.color" value="{{res.color}}" style="width: 30px; padding: 0;"/>
                </div>
                {{/each}}
            </div>
        </div>

        {{!-- Settings Tab --}}
        <div class="tab settings {{#if (eq activeTab 'settings')}}active{{/if}}" data-group="primary" data-tab="settings">
            <h3>Settings</h3>
            <div class="flexcol">
                <div class="form-group flexrow" style="margin-bottom: 10px;">
                    <label>Alternate Armour</label>
                    <input type="checkbox" name="system.settings.alternateArmour" {{checked system.settings.alternateArmour}}/>
                </div>
                <div class="form-group flexrow" style="margin-bottom: 10px;">
                    <label>Is NPC?</label>
                    <input type="checkbox" name="system.settings.isNPC" {{checked system.settings.isNPC}}/>
                </div>
                {{#if system.settings.isNPC}}
                <div class="form-group flexrow" style="margin-bottom: 10px;">
                    <label>NPC Type</label>
                    <select name="system.settings.npcType">
                        {{selectOptions npcTypeOptions selected=system.settings.npcType}}
                    </select>
                </div>
                {{#if (or (eq system.settings.npcType "squad") (eq system.settings.npcType "horde"))}}
                <div class="form-group flexrow" style="margin-bottom: 10px;">
                    <label>Size</label>
                    <input type="number" name="system.settings.squadSize" value="{{system.settings.squadSize}}"/>
                </div>
                {{/if}}
                {{/if}}
                <p class="notes" style="margin-bottom: 15px; font-size: 0.9em; color: #666; font-style: italic; border: 1px solid #ccc; padding: 5px; border-radius: 4px; background: rgba(0,0,0,0.05);">
                    <b>Alternate Armour:</b> When enabled, Armour value remains constant. Instead, every hit reduces Armour Max (HP) by 1. When Armour Max reaches 0, the armour no longer provides protection.
                </p>

                <hr>
                
                <h3>Currency Visibility</h3>
                <div class="currency-toggles flexrow" style="flex-wrap: wrap; gap: 10px; padding: 5px; background: rgba(0,0,0,0.05); border-radius: 4px;">
                    {{#each currencies as |cur|}}
                    <label style="font-size: 0.9em; white-space: nowrap; cursor: pointer; display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.5); padding: 2px 8px; border-radius: 10px; border: 1px solid #ccc;">
                        <input type="checkbox" name="system.settings.enabledCurrencies.{{cur.name}}" {{checked cur.enabled}} style="width: 14px; height: 14px; margin: 0;"/> {{cur.name}}
                    </label>
                    {{/each}}
                </div>
            </div>
        </div>
    </section>
</section>
